FROM openjdk:17-jdk-slim

WORKDIR /app

# 复制项目配置文件
COPY src/main/resources/application.properties application.properties

# 复制 mapper 文件
COPY src/main/resources/mapper /app/mapper/

# 复制 JAR 包
COPY target/*.jar app.jar

# 设置环境变量
ENV TZ=Asia/Shanghai
ENV SPRING_PROFILES_ACTIVE=prod

# 设置数据库连接
ENV MYSQL_HOST=mysql
ENV MYSQL_PORT=3306
ENV MYSQL_DATABASE=product_comparison
ENV MYSQL_USERNAME=root
ENV MYSQL_PASSWORD=root

EXPOSE 80

# 安装 mysql-client (使用 apt 而不是 apk)
RUN apt-get update && apt-get install -y default-mysql-client

# 等待 MySQL 就绪的脚本
COPY wait-for-it.sh /wait-for-it.sh
RUN chmod +x /wait-for-it.sh

# 使用 wait-for-it 确保 MySQL 就绪后再启动应用
CMD ["/wait-for-it.sh", "mysql:3306", "--", "java", "-jar", "app.jar"] 